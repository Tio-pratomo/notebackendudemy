---
title: "Middleware Fundamentals"
---

import { Aside } from '@astrojs/starlight/components';

**Middleware** adalah salah satu konsep paling penting dalam Express.js yang memungkinkan kita memproses request sebelum mencapai route handler. Memahami middleware adalah kunci untuk membangun aplikasi Express yang powerful dan terstruktur dengan baik.

## Apa itu Middleware?

**Middleware** adalah fungsi yang memiliki akses ke objek request (req), objek response (res), dan fungsi next dalam siklus request-response aplikasi. Bayangkan middleware seperti **penjaga gerbang** di depan rumah (server). Setiap tamu (request) yang datang harus melewati penjaga gerbang ini sebelum bisa masuk dan berinteraksi dengan tuan rumah (route handler).

Middleware dapat melakukan berbagai tugas:
- **Pre-processing request** - mengubah atau memvalidasi data yang masuk
- **Logging** - mencatat setiap request yang masuk untuk monitoring
- **Authentication** - memeriksa izin user sebelum mengakses resource
- **Parsing data** - mengubah format data dari form atau JSON
- **Error handling** - menangani error sebelum mencapai route handler

## Struktur Dasar Middleware

Middleware adalah fungsi dengan tiga parameter utama:

```javascript
function middlewareName(req, res, next) {
    // Lakukan sesuatu dengan req atau res
    console.log('Middleware dijalankan');
    
    // Panggil next() untuk melanjutkan ke middleware berikutnya
    next();
}
```

**Parameter penting**:
- `req` - objek request yang berisi informasi dari client
- `res` - objek response untuk mengirim balasan ke client
- `next` - fungsi untuk melanjutkan ke middleware atau route handler berikutnya

<Aside title="Catatan">
**Sangat penting**: Jika tidak memanggil `next()`, request akan "terjebak" di middleware tersebut dan server tidak akan mengirim response ke client.
</Aside>


## Built-in Middleware di Express

Express menyediakan beberapa middleware built-in yang sangat berguna:

### 1. express.json()

Middleware ini mem-parsing request body dalam format JSON dan menempatkannya di `req.body`.

```javascript
import express from 'express';
const app = express();

// Aktifkan JSON parser middleware
app.use(express.json());

app.post('/api/users', (req, res) => {
    // Sekarang bisa mengakses req.body
    const { name, email } = req.body;
    console.log('Received:', name, email);
    res.json({ message: 'User created', data: { name, email } });
});
```

**Kapan digunakan**: Saat membuat REST API yang menerima data JSON dari client.

### 2. express.urlencoded()

Middleware ini mem-parsing data dari HTML form (format URL-encoded) dan menempatkannya di `req.body`.

```javascript
// Aktifkan URL-encoded parser middleware
app.use(express.urlencoded({ extended: true }));

app.post('/submit', (req, res) => {
    // Data dari form HTML tersedia di req.body
    const { street, pet } = req.body;
    console.log('Street:', street, 'Pet:', pet);
    res.send(`Data diterima: ${street}, ${pet}`);
});
```

**Option `extended: true`**:
- `true` - menggunakan library `qs` untuk parsing (mendukung nested object)
- `false` - menggunakan library `querystring` (lebih simple)

**Best practice**: Selalu gunakan `extended: true` untuk compatibility yang lebih baik.

### 3. express.static()

Middleware untuk serving file statis seperti CSS, JavaScript, gambar:

```javascript
// Serve file statis dari folder 'public'
app.use(express.static('public'));

// Sekarang file di folder public bisa diakses langsung
// public/style.css -> http://localhost:3000/style.css
// public/images/logo.png -> http://localhost:3000/images/logo.png
```

## Application-level Middleware

Middleware yang di-bind ke instance Express application menggunakan `app.use()` atau `app.METHOD()`.

```javascript
import express from 'express';
const app = express();

// Middleware yang berjalan untuk SEMUA request
app.use((req, res, next) => {
    console.log('Time:', Date.now());
    console.log('Method:', req.method);
    console.log('URL:', req.url);
    next(); // WAJIB dipanggil!
});

// Middleware untuk path spesifik
app.use('/api', (req, res, next) => {
    console.log('API Request detected');
    next();
});

// Routes
app.get('/', (req, res) => {
    res.send('Home Page');
});

app.get('/api/users', (req, res) => {
    res.json({ users: [] });
});
```

## Router-level Middleware

Middleware yang di-bind ke instance `express.Router()` dan hanya berjalan untuk route dalam router tersebut.

```javascript
import express from 'express';
const app = express();
const router = express.Router();

// Middleware khusus untuk router ini
router.use((req, res, next) => {
    console.log('Router middleware dijalankan');
    next();
});

router.get('/profile', (req, res) => {
    res.send('User Profile');
});

router.get('/settings', (req, res) => {
    res.send('User Settings');
});

// Mount router ke aplikasi
app.use('/user', router);

// Akses: /user/profile, /user/settings
```

## Urutan Eksekusi Middleware

Urutan penempatan middleware sangat penting karena Express menjalankannya secara berurutan dari atas ke bawah.

```javascript
import express from 'express';
const app = express();

// 1. Middleware pertama
app.use((req, res, next) => {
    console.log('1. Middleware pertama');
    next();
});

// 2. Built-in middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 3. Middleware kedua
app.use((req, res, next) => {
    console.log('2. Middleware kedua');
    next();
});

// 4. Route handler
app.get('/', (req, res) => {
    console.log('3. Route handler');
    res.send('Hello');
});

// Output saat mengakses /:
// 1. Middleware pertama
// 2. Middleware kedua
// 3. Route handler
```

**Penting**: Jika `express.urlencoded()` ditempatkan SETELAH middleware custom yang mencoba mengakses `req.body`, maka `req.body` akan kosong atau undefined.

## Middleware dengan Kondisi

Middleware bisa memutuskan untuk melanjutkan atau menghentikan request:

```javascript
// Authentication middleware
const authenticate = (req, res, next) => {
    const token = req.headers.authorization;
    
    if (token === 'secret-token-123') {
        // Token valid, lanjutkan
        console.log('User authenticated');
        next();
    } else {
        // Token tidak valid, hentikan dan kirim error
        res.status(401).json({ error: 'Unauthorized' });
        // TIDAK memanggil next()
    }
};

// Route yang dilindungi
app.get('/dashboard', authenticate, (req, res) => {
    res.send('Welcome to Dashboard');
});

// Route tanpa authentication
app.get('/', (req, res) => {
    res.send('Public Home Page');
});
```

## Error Handling Middleware

Error handling middleware memiliki **4 parameter** (err, req, res, next) dan harus ditempatkan di akhir setelah semua route.

```javascript
import express from 'express';
const app = express();

// Regular routes
app.get('/', (req, res) => {
    res.send('Home');
});

app.get('/error', (req, res) => {
    // Simulasi error
    throw new Error('Something went wrong!');
});

// Error handling middleware (4 parameters!)
app.use((err, req, res, next) => {
    console.error('Error occurred:', err.message);
    
    res.status(500).json({
        error: 'Internal Server Error',
        message: err.message
    });
});
```

## Contoh Praktis: Aplikasi dengan Multiple Middleware

```javascript
import express from 'express';
const app = express();
const port = 3000;

// 1. Logger middleware - mencatat semua request
const logger = (req, res, next) => {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] ${req.method} ${req.url}`);
    next();
};

// 2. Request timing middleware
const timer = (req, res, next) => {
    req.startTime = Date.now();
    
    // Jalankan setelah response dikirim
    res.on('finish', () => {
        const duration = Date.now() - req.startTime;
        console.log(`Request duration: ${duration}ms`);
    });
    
    next();
};

// 3. Authentication middleware
const checkAuth = (req, res, next) => {
    const apiKey = req.query.apiKey;
    
    if (apiKey === 'my-secret-key') {
        next();
    } else {
        res.status(401).json({ error: 'API key required' });
    }
};

// Apply middleware
app.use(logger);
app.use(timer);
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Public routes
app.get('/', (req, res) => {
    res.send('Public Home Page');
});

// Protected routes dengan authentication
app.get('/api/data', checkAuth, (req, res) => {
    res.json({ 
        message: 'Protected data',
        data: [1, 2, 3, 4, 5]
    });
});

// Error handler
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ error: 'Something broke!' });
});

// 404 handler (harus di akhir)
app.use((req, res) => {
    res.status(404).json({ error: 'Route not found' });
});

app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});
```

## Best Practices Middleware

**Urutan yang benar**:
1. Logger middleware (untuk mencatat semua request)
2. Built-in middleware (json, urlencoded, static)
3. Custom middleware (authentication, validation)
4. Route definitions
5. 404 handler
6. Error handling middleware

**Tips penting**:
- Selalu panggil `next()` kecuali jika mengirim response
- Tempatkan middleware umum sebelum route-specific middleware
- Error handling middleware harus memiliki 4 parameter
- Gunakan `app.use()` untuk middleware global, parameter kedua di route handler untuk middleware spesifik

## Latihan Praktis

Buat file `middleware-practice.js`:

```javascript
import express from 'express';
const app = express();

// Middleware 1: Request counter
let requestCount = 0;
app.use((req, res, next) => {
    requestCount++;
    console.log(`Total requests: ${requestCount}`);
    next();
});

// Middleware 2: Method validator
app.use((req, res, next) => {
    const allowedMethods = ['GET', 'POST'];
    if (!allowedMethods.includes(req.method)) {
        return res.status(405).send('Method not allowed');
    }
    next();
});

// Built-in middleware
app.use(express.json());

// Routes
app.get('/stats', (req, res) => {
    res.json({ totalRequests: requestCount });
});

app.post('/data', (req, res) => {
    res.json({ received: req.body });
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

***

**Ringkasan**: Middleware adalah fondasi Express.js yang memungkinkan pre-processing request, authentication, logging, dan error handling. Built-in middleware seperti `express.json()` dan `express.urlencoded()` sangat penting untuk parsing data dari client. Urutan middleware sangat krusial dan fungsi `next()` harus dipanggil untuk melanjutkan ke middleware berikutnya. Error handling middleware dengan 4 parameter harus ditempatkan di akhir aplikasi.

